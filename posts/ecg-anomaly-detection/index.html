<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Time-series anomaly detection with autoencoder - (Machine) Learning log.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="monetization" content="$ilp.uphold.com/iN8Xkq2iHNHB">


<meta name="generator" content="Hugo 0.99.1" /><meta itemprop="name" content="Time-series anomaly detection with autoencoder">
<meta itemprop="description" content="One powerful use case, yet often overlooked, of the autoencoders is anomaly detection.
 In this tutorial, I will show how to use autoencoders to detect abnormal electrocardiograms (ECG).
 I will divide the tutorial in two parts. The first one, here will guide you throught the problem formulation and how to train the autoencoder neural network over the ECG data.
 I will release the next part in a week or two, so please subscribe to have the update!"><meta itemprop="datePublished" content="2023-07-23T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-07-23T00:00:00+00:00" />
<meta itemprop="wordCount" content="1631">
<meta itemprop="keywords" content="machine-learning,time-series,anomaly-detection," /><meta property="og:title" content="Time-series anomaly detection with autoencoder" />
<meta property="og:description" content="One powerful use case, yet often overlooked, of the autoencoders is anomaly detection.
 In this tutorial, I will show how to use autoencoders to detect abnormal electrocardiograms (ECG).
 I will divide the tutorial in two parts. The first one, here will guide you throught the problem formulation and how to train the autoencoder neural network over the ECG data.
 I will release the next part in a week or two, so please subscribe to have the update!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://adamoudad.github.io/posts/ecg-anomaly-detection/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-07-23T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Time-series anomaly detection with autoencoder"/>
<meta name="twitter:description" content="One powerful use case, yet often overlooked, of the autoencoders is anomaly detection.
 In this tutorial, I will show how to use autoencoders to detect abnormal electrocardiograms (ECG).
 I will divide the tutorial in two parts. The first one, here will guide you throught the problem formulation and how to train the autoencoder neural network over the ECG data.
 I will release the next part in a week or two, so please subscribe to have the update!"/>
<meta name="twitter:site" content="@OudadAdam"/>
<link rel="stylesheet" href="/css/bundle.min.262e62e9c1615dd1ac95d339cfc4ca2167aee72b71d853838920a22e7088b06b.css" integrity="sha256-Ji5i6cFhXdGsldM5z8TKIWeu5ytx2FODiSCiLnCIsGs=">
        <link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    
<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/">
        
          
            posts
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu">
      
        
          
          
            <a href="/" class="link"><i class='fa fa-home'></i> Home</a>
          
        
      
        
          
          
            <a href="/about/" class="link"><i class='far fa-id-card'></i> About</a>
          
        
      
        
          
          
            <a href="/posts/" class="link"><i class='far fa-newspaper'></i> Posts</a>
          
        
      
        
          
          
            <a href="/categories/" class="link"><i class='fas fa-sitemap'></i> Categories</a>
          
        
      
      <a href="#share-menu" class="share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
      

    </menu>
    

    <a href="#share-menu" class="share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
    <a href="#lang-menu" class="lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="lang-menu" class="flyout-menu">
  <a href="#" lang="en" class="link active">English (en)</a>
  
    
      
        <a href="/fr" lang="fr" class="no-lang link">Fran√ßais (fr)</a>
      
    
      
    
  
</menu>

  
    <menu id="share-menu" class="flyout-menu">
      <h1>Share Post</h1>
      




  
    
    <a href="//twitter.com/share?text=Time-series%20anomaly%20detection%20with%20autoencoder&amp;url=https%3a%2f%2fadamoudad.github.io%2fposts%2fecg-anomaly-detection%2f" target="_blank" rel="noopener" class="share-btn twitter">
        <i class="fab fa-twitter"></i><p>&nbsp;Twitter</p>
      </a>
  

  
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fadamoudad.github.io%2fposts%2fecg-anomaly-detection%2f&amp;title=Time-series%20anomaly%20detection%20with%20autoencoder" target="_blank" rel="noopener" class="share-btn linkedin">
            <i class="fab fa-linkedin"></i><p>&nbsp;LinkedIn</p>
          </a>
  


    </menu>
  
</header>

    <div id="wrapper">
      <section id="site-intro" >
  <a href="/"><img src="/avatar.png" class="circle" width="150" alt="Adam Oudad" /></a>
  <header>
    <h1>Adam Oudad</h1>
  </header>
  <main>
    <p>(Machine) Learning log.</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/adamoudad" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>

<li><a href="//stackoverflow.com/users/7013114/adam-oudad" target="_blank" rel="noopener" title="Stack Overflow" class="fab fa-stack-overflow"></a></li>








<li><a href="//medium.com/@adam.oudad" target="_blank" rel="noopener" title="Medium" class="fab fa-medium"></a></li>
<li><a href="//linkedin.com/in/adamoudad" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/OudadAdam" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>







<li><a href="//researchgate.net/profile/Adam_Oudad" target="_blank" rel="noopener" title="Research Gate"><i class="ai ai-researchgate"></i></a></li>





      </ul>
    </footer>
  
</section>

      <main id="site-main">
        <article class="post">
  <header>
  <div class="title">
    
        <h2><a href="/posts/ecg-anomaly-detection/">Time-series anomaly detection with autoencoder</a></h2>
    
    
</div>
  <div class="meta">
    <time class="published" datetime="2023-07-23 00:00:00 &#43;0000 UTC">
      July 23, 2023
    </time>
    <span class="author"></span>
    
      <p>8 minutes read</p>
    
  </div>
</header>

  <section id="socnet-share">
    




  
    
    <a href="//twitter.com/share?text=Time-series%20anomaly%20detection%20with%20autoencoder&amp;url=https%3a%2f%2fadamoudad.github.io%2fposts%2fecg-anomaly-detection%2f" target="_blank" rel="noopener" class="share-btn twitter">
        <i class="fab fa-twitter"></i><p>&nbsp;Twitter</p>
      </a>
  

  
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fadamoudad.github.io%2fposts%2fecg-anomaly-detection%2f&amp;title=Time-series%20anomaly%20detection%20with%20autoencoder" target="_blank" rel="noopener" class="share-btn linkedin">
            <i class="fab fa-linkedin"></i><p>&nbsp;LinkedIn</p>
          </a>
  


  </section>
  

  <div class="content">
    
<p>
One powerful use case, yet often overlooked, of the autoencoders is anomaly detection.</p>
<p>
In this tutorial, I will show how to use autoencoders to detect abnormal electrocardiograms (ECG).</p>
<p>
I will divide the tutorial in two parts. The first one, here will guide you throught the problem formulation and how to train the autoencoder neural network over the ECG data.</p>
<p>
I will release the next part in a week or two, so please subscribe to have the update!</p>
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
What is anomaly detection?
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>A customer using an ATM, an electrocardiogram measured from a patient in a hospital, a connection status to a server, a machine operating on some task, etc. These may all be described as situations with two clearly defined statuses.</p>
<ul>
<li>A correct status, where things work as expected.</li>
<li>An abnormal status, which would be the other case.</li>
</ul>
<p>In the case of a customer using an ATM, an abnormal status would be caused by the user being an attacker, or by the system not working properly.</p>
<p>
It is crucial to automatically detect such abnormal situations, which will save security or maintenance cost.</p>
<p>
Thanks to their ability to condense data into a meaningful representation, autoencoders can be used to detect abnormal behaviors.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Autoencoders
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>Autoencoders have been tremendously useful for denoising data and data compression.</p>
<p>
These models are able to compress input data into a meaningful internal representation, that can be reused for downstream tasks, such as text summarization, machine translation, object detection in images, and so on.</p>
<p>
Their versatility makes their strength. They have been first presented in 1986 using multi-layer perceptrons as their building blocks, but have been shown to adapt quite well to many types of data, by changing their architectures. For example, they were used to improve the results of image classification, by basing their architecture on convolutional neural networks.</p>
<p>
Their architecture is quite simple. One part, called the encoder, is responsible for extracting an internal representation from input data. The other part, called the decoder, is responsible for reconstructing data back to its original form, given the internal representation.</p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
How to use autoencoders for anomaly detection?
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>
Remember that autoencoders are good at one thing, which is to extract a meaningful representation out of some data. This might sound esoteric, but let&#39;s explain why it will help in anomaly detection.</p>
<p>
An autoencoder is trained using unsupervised learning, on some unlabeled data, to reconstruct its input data, after having calculated an internal representation of it. By doing so, the autoencoder gets better at optimizing some criterion on the &#34;normal data&#34; subset we can gather, from all the possible input data.</p>
<p>
By definition, abnormal data should show some peculiar features, which would make the autoencoder&#39;s task of reconstructing the abnormal data from the internal representation harder. But this is exactly what we want!</p>
<p>
At this point, we can define a protocol for us tackle anomaly detection using autoencoders.</p>
<ol>
<li>Train an autoencoder on our normal data subset.</li>
<li>Compare the autoencoder&#39;s criterion on the normal data subset, and the abnormal data subset.</li>
<li>Define a threshold for us to safely classify data as abnormal or normal.</li>
</ol>
<p>
This last step is trickier than it sounds, as it will highly depend on our understanding of the problem and whether we are using the right tools.</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
Quick exploratory data analysis of electrocardiogram data
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>The ECG5000 dataset <a href="http://www.timeseriesclassification.com/description.php?Dataset=ECG5000">http://www.timeseriesclassification.com/description.php?Dataset=ECG5000</a> is a collection of time-series data of measured heartbeat from patients with severe congestive heart failure. The data is labelled by 0 if the heartbeat is abnormal, and 1 if it is normal.</p>
<p>
Let&#39;s get the data from <a href="https://www.tensorflow.org/tutorials/generative/autoencoder#third_example_anomaly_detection">this Tensorflow tutorial</a>.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dataframe <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;http://storage.googleapis.com/download.tensorflow.org/data/ecg.csv&#39;</span>, header<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>raw_data <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>dataframe<span style="color:#f92672">.</span>head()</span></span></code></pre></div>
</div>
<p>We can see that the labels (0 or 1 values) of each ECG is on the last column, and the other columns are the time-series data points of the ECG.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>labels <span style="color:#f92672">=</span> raw_data[:, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> raw_data[:, <span style="color:#ae81ff">0</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]</span></span></code></pre></div>
</div>
<p>
Let&#39;s visualize some data. The following will plots two samples, one normal, one abnormal, that I randomly chose from the dataset.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>normal_ecg <span style="color:#f92672">=</span> data[labels <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>abnormal_ecg <span style="color:#f92672">=</span> data[labels <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(normal_ecg, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Normal&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(abnormal_ecg, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Abnormal&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()</span></span></code></pre></div>
</div>
<p>
<figure><img src="normal-abnormal-one-sample.png"
         alt="One sample of normal and abnormal data."/><figcaption>
            <p>One sample of normal and abnormal data.</p>
        </figcaption>
</figure>
</p>
<p>
We can see some differences between the two curves, but one sample comparison does not give much information on the general patterns that a normal ECG should follow. Let&#39;s go further and plot the mean ECG for both our normal and abnormal samples.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>normal_ecg_mean <span style="color:#f92672">=</span> data[labels <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>mean(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>abnormal_ecg_mean <span style="color:#f92672">=</span> data[labels <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>mean(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(normal_ecg_mean, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Normal mean&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(abnormal_ecg_mean, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Abnormal mean&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()</span></span></code></pre></div>
</div>
<figure><img src="normal-abnormal-mean.png"
         alt="Normal and abnormal data mean."/><figcaption>
            <p>Normal and abnormal data mean.</p>
        </figcaption>
</figure>

<p>
Interestingly, we can note some striking differences.</p>
<ul>
<li>Normal data tend to have a lower minimum than abnormal data, appearing at around the first timesteps.</li>
<li>Normal data tend to have a maximum value occurring at around timestep 100. This is not the case for abnormal data.</li>
<li>Normal data tend to have a second spike near the end of the ECG which is not found on abnormal data.</li>
</ul>
<p>
We now seem to have quite a fair amount of information to classify data as &#34;normal&#34; or &#34;abnormal&#34;, but how to transfer this intuitive knowledge into some reliable heuristic? And would our quick analysis of the mean values suffice to get good generalization?</p>
<p>
It may be tempting to start hand-crafting some criterion for the classification problem but a better approach is to use machine learning in this case, because of the complexity of the problem.</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
Build an autoencoder for time-series data
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>Due to the relatively small size of the ECG samples (only 140 values per data sample), we can use an autoencoder architecture formed of multi-layer perceptrons.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Autoencoder</span>(torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, input_size<span style="color:#f92672">=</span><span style="color:#ae81ff">140</span>):
</span></span><span style="display:flex;"><span>        super(Autoencoder, self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>enc1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(input_size, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>enc2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>enc3 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>relu <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>functional<span style="color:#f92672">.</span>relu
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>sigmoid <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sigmoid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dec1 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dec2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>dec3 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">32</span>, input_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encoder</span>(self, x):
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>enc1(x)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>enc2(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>enc3(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(outputs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> outputs
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decoder</span>(self, x):
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dec1(x)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dec2(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dec3(outputs)
</span></span><span style="display:flex;"><span>        outputs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sigmoid(outputs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> outputs
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, x):
</span></span><span style="display:flex;"><span>        encoded <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>encoder(x)
</span></span><span style="display:flex;"><span>        decoded <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>decoder(encoded)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> decoded
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>autoencoder <span style="color:#f92672">=</span> Autoencoder()</span></span></code></pre></div>
</div>
<p>
The reasons behind using a particular architecture are often empirically based on past research, and we can note the following.</p>
<ul>
<li>ReLU activation layers are used to improve the autoencoder&#39;s ability to learn non-linear representations.</li>
<li>Using a stack of linear layers gives more depth to the network, and has been shown to provide faster convergence. This is one of the results behind the &#34;deep&#34; in Deep learning.</li>
<li>The encoder progressively compresses the input data into an internal representation with smaller size (8-dimensional vector). This is to force the autoencoder to learn meaningful representation of the data, by discarding unnecessary information, while optimizing the criterion we will introduce in the following.</li>
</ul>
<p>
To train our autoencoder we need two things.</p>
<ul>
<li>A criterion, or loss function.</li>
<li>An optimization strategy.</li>
</ul>
<p>
For time-series data, it is very common and wise to use some loss function based on the residuals (the error values obtained by subtracting the target values with the outputs values, for each timestep.). We will use the mean absolute error, or L1 loss, in PyTorch. Finally, let&#39;s use Adam optimizer, one of the most robust optimizers in current research.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(autoencoder<span style="color:#f92672">.</span>parameters())
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>L1Loss()</span></span></code></pre></div>
</div>
<p>
We can keep only the normal data as training data. But to give us more confidence on the final result, let&#39;s split our training data into a train and test split. The test split won&#39;t be used for training the autoencoder, but will be used to test it against unseen data and have an idea of its ability to generalize to unseen data, that is, to correctly classify as normal data, normal ECG data it has never seen before.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_test_split</span>(data, labels, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, random_state<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Split the data into train and test sets.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Decide the split index</span>
</span></span><span style="display:flex;"><span>    split_index <span style="color:#f92672">=</span> int(len(data) <span style="color:#f92672">*</span> test_size)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Randomly shuffle the indices</span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>seed(a<span style="color:#f92672">=</span>random_state)
</span></span><span style="display:flex;"><span>    random_indices <span style="color:#f92672">=</span> list(range(len(data)))
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(random_indices)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Shuffle the data</span>
</span></span><span style="display:flex;"><span>    shuffled_data <span style="color:#f92672">=</span> data[random_indices]
</span></span><span style="display:flex;"><span>    shuffled_labels <span style="color:#f92672">=</span> labels[random_indices]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Split the data</span>
</span></span><span style="display:flex;"><span>    test_data, train_data <span style="color:#f92672">=</span> shuffled_data[:split_index], shuffled_data[split_index:]
</span></span><span style="display:flex;"><span>    test_labels, train_labels <span style="color:#f92672">=</span> shuffled_labels[:split_index], shuffled_labels[split_index:]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> train_data, test_data, train_labels, test_labels</span></span></code></pre></div>
</div>
<p>
Let&#39;s compute our train and test split. We also normalize the data for the autoencoder. Although anomalous data is not used during training, we keep it in the data when we split in train and test sets, to be able to make correct assumptions over the data distribution.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Split the data</span>
</span></span><span style="display:flex;"><span>train_data, test_data, train_labels, test_labels <span style="color:#f92672">=</span> train_test_split(
</span></span><span style="display:flex;"><span>    data, labels, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Normalize the data</span>
</span></span><span style="display:flex;"><span>min_val <span style="color:#f92672">=</span> train_data<span style="color:#f92672">.</span>min()
</span></span><span style="display:flex;"><span>max_val <span style="color:#f92672">=</span> train_data<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_data <span style="color:#f92672">=</span> (train_data <span style="color:#f92672">-</span> min_val) <span style="color:#f92672">/</span> (max_val <span style="color:#f92672">-</span> min_val)
</span></span><span style="display:flex;"><span>test_data <span style="color:#f92672">=</span> (test_data <span style="color:#f92672">-</span> min_val) <span style="color:#f92672">/</span> (max_val <span style="color:#f92672">-</span> min_val)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(train_data, dtype<span style="color:#f92672">=</span>float)
</span></span><span style="display:flex;"><span>test_data <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(test_data, dtype<span style="color:#f92672">=</span>float)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_labels <span style="color:#f92672">=</span> train_labels<span style="color:#f92672">.</span>astype(bool)
</span></span><span style="display:flex;"><span>test_labels <span style="color:#f92672">=</span> test_labels<span style="color:#f92672">.</span>astype(bool)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>normal_train_data <span style="color:#f92672">=</span> train_data[train_labels]
</span></span><span style="display:flex;"><span>normal_test_data <span style="color:#f92672">=</span> test_data[test_labels]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>anomalous_train_data <span style="color:#f92672">=</span> train_data[<span style="color:#f92672">~</span>train_labels]
</span></span><span style="display:flex;"><span>anomalous_test_data <span style="color:#f92672">=</span> test_data[<span style="color:#f92672">~</span>test_labels]</span></span></code></pre></div>
</div>
<p>
With everything arranged, we can now run the training of the autoencoder.</p>
<div class="src src-python">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> trange
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>losses <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>autoencoder <span style="color:#f92672">=</span> autoencoder<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>autoencoder <span style="color:#f92672">=</span> autoencoder<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n_batches <span style="color:#f92672">=</span> len(train_data) <span style="color:#f92672">//</span> batch_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> trange(epochs) <span style="color:#66d9ef">as</span> tbar:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> tbar:
</span></span><span style="display:flex;"><span>        epoch_loss <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(normal_train_data), batch_size):
</span></span><span style="display:flex;"><span>            batch <span style="color:#f92672">=</span> normal_train_data[i:i<span style="color:#f92672">+</span>batch_size]
</span></span><span style="display:flex;"><span>            optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            outputs <span style="color:#f92672">=</span> autoencoder(batch<span style="color:#f92672">.</span>float())
</span></span><span style="display:flex;"><span>            loss <span style="color:#f92672">=</span> criterion(outputs, batch<span style="color:#f92672">.</span>float())
</span></span><span style="display:flex;"><span>            epoch_loss <span style="color:#f92672">+=</span> loss<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>            loss<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        losses<span style="color:#f92672">.</span>append(epoch_loss)
</span></span><span style="display:flex;"><span>        tbar<span style="color:#f92672">.</span>set_postfix(loss<span style="color:#f92672">=</span>epoch_loss <span style="color:#f92672">/</span> float(n_batches))</span></span></code></pre></div>
</div>
<p>
And see the learning curve.</p>
<p>
<figure><img src="autoencoder-training-loss.png"
         alt="Autoencoder training loss"/><figcaption>
            <p>Autoencoder training loss</p>
        </figcaption>
</figure>
</p>
<p>
This looks good! The loss decreased to lower magnitudes of values. Let&#39;s go ahead and reconstruct some data. We can use the normal and abnormal ECG data above.</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
Conclusion
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>We saw how we can train an autoencodder over electrocardiogram (ECG) data. In my following article, I will show how to use our trained autoencoder to actually detect anomalies using a carefully tuned threshold.</p>
<p>
Please subscribe to see my upcoming articles!</p>
</div>
</div>

  </div>
  <footer>
    <ul class="stats">
  
    
    
      <li class="categories">
        <ul>
          
            
            <li><a class="article-category-link" href="https://adamoudad.github.io/categories/machine-learning">Machine Learning</a></li>
          
        </ul>
      </li>
    
  
  
    
    
      <li class="tags">
        <ul>
          
            
            <li><a class="article-category-link" href="https://adamoudad.github.io/tags/machine-learning">machine-learning</a></li>
          
            
            <li><a class="article-category-link" href="https://adamoudad.github.io/tags/time-series">time-series</a></li>
          
            
            <li><a class="article-category-link" href="https://adamoudad.github.io/tags/anomaly-detection">anomaly-detection</a></li>
          
        </ul>
      </li>
    
  
</ul>

  </footer>
</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "adamoudad-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>




<div class="pagination">
  
    <a href="/posts/emacs/remote-command-ssh/" class="button"><div class="previous"><div>Run a command on a remote server with Emacs.</div></div></a>
  
  
    <a href="/posts/monty-hall/" class="button"><div class="next"><div>The Monty Hall problem... Should I stay or should I change?</div></div></a>
  
</div>


      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent posts</h1>
      </header>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/posts/monty-hall/">The Monty Hall problem... Should I stay or should I change?</a></h1>
          <time class="published" datetime="">February 24, 2024</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/posts/ecg-anomaly-detection/">Time-series anomaly detection with autoencoder</a></h1>
          <time class="published" datetime="">July 23, 2023</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/posts/emacs/remote-command-ssh/">Run a command on a remote server with Emacs.</a></h1>
          <time class="published" datetime="">December 22, 2022</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/posts/python-statements/">These Python keywords will simplify your code</a></h1>
          <time class="published" datetime="">October 16, 2022</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/posts/pdfpc/">Keynote presentation on Linux</a></h1>
          <time class="published" datetime="">October 15, 2022</time>
        </header>
      </article>
      
      
        <a href="/posts/" class="button">See more</a>
      
    </section>
  

  
    
      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
            
          
          
          <li>
            
              <a href="/categories/machine-learning/">machine-learning<span class="count">10</span></a>
            
          
          <li>
            
              <a href="/categories/programming/">programming<span class="count">6</span></a>
            
          
          <li>
            
              <a href="/categories/linux/">linux<span class="count">3</span></a>
            
          
          <li>
            
              <a href="/categories/natural-language-processing/">natural-language-processing<span class="count">3</span></a>
            
          
          <li>
            
              <a href="/categories/python/">python<span class="count">3</span></a>
            
          
          <li>
            
              <a href="/categories/emacs/">emacs<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/japanese/">japanese<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/security/">security<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/web/">web<span class="count">2</span></a>
            
          
          <li>
            
              <a href="/categories/computer/">computer<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/linguistic/">linguistic<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/random/">random<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/statistics/">statistics<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/tools/">tools<span class="count">1</span></a>
            
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>This website is a weblog were I write about computer science, machine learning, language learning.</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        

        <li><a href="//github.com/adamoudad" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>

<li><a href="//stackoverflow.com/users/7013114/adam-oudad" target="_blank" rel="noopener" title="Stack Overflow" class="fab fa-stack-overflow"></a></li>








<li><a href="//medium.com/@adam.oudad" target="_blank" rel="noopener" title="Medium" class="fab fa-medium"></a></li>
<li><a href="//linkedin.com/in/adamoudad" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/OudadAdam" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>







<li><a href="//researchgate.net/profile/Adam_Oudad" target="_blank" rel="noopener" title="Research Gate"><i class="ai ai-researchgate"></i></a></li>





      </ul>
  
  <p class="copyright">
    
      &copy; 2024
      
        (Machine) Learning log.
      
    . <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.99.1' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>


      <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script><script src="/js/bundle.min.d0b3e0b5f2cfc7467ead7d316ecb9dea4d29ef3c23ad300df9d7017ff98b2331.js" integrity="sha256-0LPgtfLPx0Z&#43;rX0xbsud6k0p7zwjrTAN&#43;dcBf/mLIzE="></script>
    <script src="/js/add-on.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKMEYDZ08Y"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-ZKMEYDZ08Y', { 'anonymize_ip': false });
}
</script>

    </div>
  </body>
</html>
